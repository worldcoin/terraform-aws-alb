name: Terraform
on:
  push:
    branches:
      - main

jobs:
  docs:
    name: docs
    runs-on: arc-large-arm64-runner

    permissions:
      pull-requests: write
      contents: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        name: Checkout source code

      - name: Render terraform docs inside the README.md and push changes back to main branch
        uses: terraform-docs/gh-actions@e47bfa196e79fa50987ef391be236d9d97b0c786

      # fix to terraform-docs action change ownership of files
      - name: Update ownership of files
        run: |
          sudo chown $(id -u):$(id -g) -R .git/

      - name: Check for available updates
        id: check-existence
        run: |
          echo "::set-output name=branches::$(git ls-remote --heads origin generated-docs-\* | tr -d '\n')"

      - name: Create Pull Request
        if: steps.check-existence.outputs.branches == ''
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c
        with:
          title: Update terraform docs
          branch: generated-docs
          branch-suffix: short-commit-hash
          delete-branch: true
          commit-message: "docs: autogenerated docs"
          add-paths: |
            **/README.md
